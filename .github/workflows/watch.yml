name: Run DBLP Watch

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [main]

permissions: write-all

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Kolkata"
      RUN_ENV: "prod" # within ['prod', 'dev']
      GH_USER: ${{ github.repository_owner }}
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      # ============================================
      # TODO [√] 检查工作分支及 Workflows 运行环境
      # ============================================
      - name: Checkout dblp-paper-daily repository
        uses: actions/checkout@v3
        with:
          path: paper-tracker
      # 2. Checkout awesome-topics
      - name: Checkout awesome-topics
        uses: actions/checkout@v4
        with:
          repository: sadimanna/awesome-topics
          path: awesome-topics
          token: ${{ secrets.GITHUB_TOKEN }}
      # ============================================
      # TODO [√] 创建 Python3.6+ 编译环境
      # ============================================
      - name: Set up Python 3.8
        uses: actions/setup-python@v3
        with:
          python-version: 3.8
      # ============================================
      # TODO [√] 安装 Project 第三方依赖
      # ============================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f paper-tracker/requirements.txt ]; then pip install -r paper-tracker/requirements.txt; fi
          if [ -f awesome-topics/requirements.txt ]; then pip install -r awesome-topics/requirements.txt; fi
      # ============================================
      # TODO [√] 测试 Scaffold 脚手架指令
      # ============================================
      - name: Run dblp watcher
        run: |
          cd paper-tracker/src
          python main.py run --env=${{ env.RUN_ENV }}

      - name: Setup var
        id: vars
        run: |
          content="$(cat <<'EOF'
            ${{ env.MSG }}
            EOF
            )"
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          echo "content=$content" >> "$GITHUB_OUTPUT"
      # ============================================
      # TODO [√] 更新仓库数据
      # ============================================
      # - name: Setup GIT user
      #   uses: fregante/setup-git-user@v1
      #   with:
      #     # Tell the action where the .git folder actually is
      #     working-directory: paper-tracker

      # - name: Push done work
      #   working-directory: paper-tracker
      #   run: |
      #     git diff --exit-code || git commit -am "Automated deployment @ $(date '+%Y-%m-%d %H:%M:%S') ${{ env.TZ }}"
      #     git push --force origin main

      # ============================================
      # Updated: Push work for paper-tracker
      # ============================================
      - name: Push done work (paper-tracker)
        working-directory: paper-tracker
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _data _configs cached
          git diff --staged --quiet || (git commit -m "Automated deployment @ $(date '+%Y-%m-%d %H:%M:%S') ${{ env.TZ }}" && git push --force origin main)

      # ... intermediate steps ...

      - name: Create an issue for new papers
        if: ${{ env.MSG != '' }}
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MSG: ${{ steps.vars.outputs.content }}
        with:
          filename: .github/issue-template.md
      
      # 6. Regenerate README
      - name: Update README
        run: |
          cd awesome-topics/scripts
          python main.py merge_md_yaml

      # 7. Commit & push
      # ============================================
      # Updated: Push work for awesome-topics
      # ============================================
      - name: Push (awesome-topics)
        working-directory: awesome-topics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs _data README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update papers from DBLP" && git push)
      # - name: Commit changes
      #   run: |
      #     cd awesome-topics
      #     git config user.name "github-actions"
      #     git config user.email "github-actions@github.com"
      #     git add data.yaml README.md
      #     git commit -m "Auto-update papers from DBLP" || exit 0
      #     git push

      # - name: Get date time
      #   id: date
      #   run: echo "::set-output name=date::$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # - name: Commit Updated
      #   uses: stefanzweifel/git-auto-commit-action@v4
      #   with:
      #     commit_message: "auto update @ ${{ steps.date.outputs.date }} ${{ env.TZ }}"
